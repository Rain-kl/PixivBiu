# PixivBiu 二开需求文档（对接 Immich：直传 + 堆叠 + 按作者相册归档）

## 1. 背景与目标

### 1.1 背景

PixivBiu 是用于浏览与批量下载 Pixiv 图片的第三方软件。当前批量下载功能默认将作品图片下载并存储到本地。

### 1.2 改造目标

1. **批量下载直传 Immich**：PixivBiu 本地不再持久化存储下载图片（可选保留临时文件），下载完成后直接上传至 Immich（使用 Immich 资产上传 API）。
2. **堆叠模拟 Pixiv 多图作品展示**：Pixiv 作品可能包含一组图片（多 P）。上传至 Immich 后，将同一作品的多张图在 Immich 中创建 Stack（堆叠），模拟 Pixiv 的组图展示效果。
3. **按作者自动建相册并归类**：以作者名称（或作者唯一标识）创建 Immich 相册，并将该作者下载的作品（资产）加入对应相册。相册支持创建时带入初始资产 ID。
4. **新增配置项**：
   - 存储模式：本地存储 / Immich 存储
   - Immich 连接信息：host、token(API Key)（以及建议的可选项：是否校验 TLS、自定义 basePath 等）

---

## 2. 范围定义

### 2.1 In Scope（本期实现）

- **批量下载流程支持两种存储模式**：
  - 本地存储（沿用现有逻辑）
  - Immich 存储（新增）
- **Immich 存储模式下**：
  - 对每个 Pixiv 作品的每张图片逐张上传为 Immich Asset（图片资产）
  - 将同一作品的一组 Asset 创建为一个 Stack（堆叠）
  - 按作者创建/复用相册，并将该作品的 Asset 加入相册（创建相册时可传 assetIds；后续也可用“添加资产到相册”的 API——若项目采用该方式，请在技术方案中补充对应端点）

---

## 3. 角色与使用场景（User Stories）

1. 作为用户，我希望把 Pixiv 批量下载的图片自动上传到 Immich，而不是占用手机/电脑本地空间。
2. 作为用户，我希望 Pixiv 的多图作品在 Immich 里能以“堆叠/组图”的方式查看，避免时间线被刷屏。
3. 作为用户，我希望按作者自动归档到对应相册，方便管理与回看。

---

## 4. 功能需求

### 4.1 设置与配置

新增配置项：
- `storageMode`：枚举
  - `LOCAL`（本地存储）
  - `IMMICH`（Immich 存储）
- `immich.host`：字符串
  - 示例：`https://immich.example.com`
- `immich.apiKey`：字符串（token）
- （建议）连接测试按钮：调用 Immich “获取服务信息/或任意轻量接口”验证 token 有效性（可用 Immich API 文档建议的认证方式）

### 4.2 批量下载（Immich 存储模式）

#### 4.2.1 作品与图片映射

- Pixiv 一个作品（illustration/manga）可能包含 N 张图片（P1..PN）
- 需要保留以下元信息用于命名/归档：
  - `pixivArtworkId`
  - `title`
  - `authorId`、`authorName`
  - `pageIndex`（1..N）
  - `sourceUrl`（可选存为 asset metadata/description）

#### 4.2.2 上传资产（Asset Upload）

- 对每张图片，调用 Immich “Upload asset” 接口上传二进制文件（multipart 表单含 assetData 等字段）。
- 上传返回 Asset 信息（至少需要拿到 `assetId`）用于后续：
  - 创建堆叠（stack）
  - 加入相册（album）

**实现（体验/性能）**：
- 支持并发上传（可配置最大并发数）
- 支持失败重试（如网络错误/5xx）
- 对大批量任务提供进度条：作品级进度 + 图片级进度

### 4.3 堆叠（Stacking）模拟 Pixiv 组图展示

#### 4.3.1 创建堆叠

- 对同一作品上传得到的 `assetIds[]`，调用 Immich “Create Stack” 接口创建堆叠。
- Stack 概念：一个 primary asset + 多个 child assets，时间线默认只展示 stack parent（更接近 Pixiv 组图效果）。

**堆叠命名建议**：
- `stackName = "{authorName} - {pixivArtworkId} - {title}"`（长度限制如有需裁剪）

**Primary 选择策略（建议）**：
- 默认选 P1 作为 primary
- （可选增强）如果 Pixiv 返回有封面/代表图标识，选代表图

### 4.4 相册（Album）按作者归档

#### 4.4.1 创建/复用相册

- 相册名：`authorName`（注意同名作者冲突；建议拼接 authorId：`{authorName} ({authorId})`）
- 当某作者首次上传时：
  - 调用 Immich “Create Album” 创建相册，可附带初始 `assetIds`（该作品全部图片）。
- 若相册已存在：
  - 将新作品的 `assetIds` 加入该相册（实现方式取决于 Immich 是否提供“向相册追加资产”的端点；若采用创建相册时带资产的方式，则需额外调用“添加资产”类端点完成追加 —— 请在技术方案阶段补齐对应 API 选型）

#### 4.4.2 本地索引缓存（建议）

为避免每次都全量搜索相册：
- 本地维护 `authorKey` -> `albumId` 映射缓存
- 失效策略：
  - token/host 变更即清空
  - 发现 API 返回 404/权限错误则重新查询/重建

---

## 5. 业务流程（Immich 模式）

1. 用户配置 Immich 存储，填写 host/apiKey，启动应用时进行连接测试, 测试失败退出程序
2. 用户发起“批量下载”
3. PixivBiu 获取作品列表 → 对每个作品：
   1. 获取作品的图片 URL 列表（P1..PN）
   2. 逐张下载到内存/临时文件（不落地或短暂落地）
   3. 调用 Immich 上传接口 → 得到 `assetIds[]`
   4. 调用 Immich 创建 stack（`assetIds[]`）
   5. 获取/创建作者相册 → 将 `assetIds[]` 加入相册
4. 任务结束：输出成功/失败清单，可一键重试失败项

---

## 6. 异常与边界条件

- **网络中断/上传失败**：支持单图重试、作品重试、任务断点续传（可选）
- **token 无权限/过期**：连接测试阶段提示；运行阶段捕获 401/403 并中止后续上传，提示用户更新 token。
- **重复下载/重复上传**：不要进行重命名, 覆盖或者跳过
  - **MVP**：不做去重（由用户自行管理）
  - （可选）用 Pixiv 的 `artworkId` + `pageIndex` 作为 `deviceAssetId`/自定义字段，配合 Immich 的 “bulk upload check / exist” 能力做去重（如需要再补充详细 API 方案）
- **作者名非法字符/太长**：相册名进行清洗与裁剪
- **同名作者冲突**：通过 `authorId` 后缀规避
- **同名图片冲突**：通过 `pixivArtworkId` + `pageIndex` 后缀规避

---

## 7. 非功能需求

- **性能**：批量下载 1000 张图时不卡 UI；上传并发可控
- **稳定性**：失败重试、错误分类（网络/鉴权/服务端）
- **日志中避免打印完整 token**
- **可观测**：提供上传失败原因、HTTP 状态码、请求耗时统计（可选）

---

## 8. 验收标准（Acceptance Criteria）

1. 当 存储模式=Immich：
   - 批量下载不会在本地形成长期图片文件（允许临时文件，任务结束自动清理）
   - 每张图都成功出现在 Immich 资产库中
2. 同一 Pixiv 作品的多张图在 Immich 中形成同一 Stack，时间线呈现“堆叠”效果
3. 作品按作者自动进入对应作者相册；作者首次出现会自动创建相册
4. 可在设置中切换回 本地存储，原本地下载逻辑不受影响
5. host/token 配置错误时，连接测试能给出明确失败提示；运行中遇到鉴权失败能中止并提示用户处理

---

## 9. 补充说明

- 需要“去重上传”,同作品反复下载时避免重复资产
- 需要把 Pixiv 元数据（作品 ID、作者、标题、tag、sourceUrl）写入 Immich 的 metadata（如要做，需要选定 Immich 支持的元数据写入方式/字段）
- immich api 参考官方文档: https://api.immich.app/endpoints